/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
function dependOn(){"use strict";return[require("util"),require("common"),require("analytics"),require("proxy"),require("floodgate"),require("sharepoint-module")]}var def;require=function(e){"use strict";return e},def=window.define?window.define:function(e,t){"use strict";return t.apply(null,[{ajax:$.ajax.bind($)}])};var exports=acom_analytics={};def(dependOn(),(function(e,t,s,i,n,o){"use strict";var r,a,l=null,d={};for(r in l||(l=new function(){var r={},l={};this.proxy=i.proxy.bind(this),this.LOG=t.LOG,this.registerHandlers=function(t){e.extend(r,t)},this.registerModule=function(e,t){d[e]=t},this.getModule=function(e){return d[e]},this.getTabLastMessage=function(e){return l[e]},this.updateTabMessage=function(t,s){l[t]?l[t]=e.extend(l[t],s):l[t]=s},this.version=-1,this.cookieStatus=void 0,this.legacyShim=function(){return this.version<=1},this.setVersion=function(e){this.version=e},this.setCookieStatus=function(e){this.cookieStatus=e},this.getCookieStatus=function(){return this.cookieStatus},this.resetPersistPrefCount=function(){e.setCookie("persist-menu-closed",0,3650)},this.incrementPersistPrefCount=function(){let t=e.getCookie("persist-menu-closed");t<10&&"false"!==e.getCookie("always-show-pdf-menu")&&(t++,e.setCookie("persist-menu-closed",t,3650)),t>=10&&(e.setCookie("always-show-pdf-menu","false",3650),s.event(s.e.PERSIST_PDF_OPENPDF_PREF_OFF))},this.isEnablePersistMenu=function(){return SETTINGS.VIEWER_ENABLED&&(SETTINGS.IS_ACROBAT&&!SETTINGS.VIEWER_ENABLED_FOR_ACROBAT||e.getCookie("fteDenied")||"true"!==e.getCookie("pdfViewer")||this.resetPersistPrefCount()),"false"!==e.getCookie("always-show-pdf-menu")&&(e.getCookie("persist-menu-closed")<10?!(this.legacyShim()&&(!SETTINGS.VIEWER_ENABLED||e.getCookie("pdfViewer"))):"true"===e.getCookie("always-show-pdf-menu")&&(this.resetPersistPrefCount(),!0))},this.isViewerEnabled=function(){return!(!SETTINGS.VIEWER_ENABLED||SETTINGS.IS_ACROBAT&&!SETTINGS.VIEWER_ENABLED_FOR_ACROBAT||"true"!==e.getCookie("pdfViewer"))},this.relayMessageToContentScript=function(e){1==e.newUI&&"dismiss"===e.content_op?(e.persist=!1,null!=e.tabId&&(l[e.tabId].persist=!1),this.incrementPersistPrefCount()):1==e.newUI&&"pdf_menu"===e.panel_op&&(this.isEnablePersistMenu()?null!=e.tabId&&(l[e.tabId].persist=!0):e.persist=!1,this.resetPersistPrefCount()),this.sendMessage(e)},this.sendViewerStartupInformation=function(t,s){if(this.isViewerEnabled()&&e.isViewerURL(s)){if("viewer-startup"===t.main_op&&this.isViewerEnabled()&&e.isViewerURL(s)&&(delete t.main_op,t.isFrictionlessEnabled=SETTINGS.FRICTIONLESS_ENABLED,t.isSharePointEnabled=o.isFeatureEnabled(),t.isSharePointURL=!1),t.isSharePointEnabled)try{let e=new URL(s).searchParams.get("pdfurl");t.isSharePointURL=o.isAllowListedSharePointURL(e)}catch(e){}t.main_op="viewer-startup-response",t.featureFlags=n.getFeatureFlags(),this.sendMessage(t)}},this.handleThirdPartyCookiesResponse=function(t,s){this.setCookieStatus(t.cookies_status),(this.version===SETTINGS.READER_VER||0===this.version||1===this.version&&0==e.getNMHConnectionStatus())&&(t.cookies_status||(SETTINGS.FRICTIONLESS_ENABLED=!1,this.version===SETTINGS.READER_VER&&this.avoidUrl(s.tab.url)?this.disable(t.tabId):0===this.version||1===this.version&&e.getNMHConnectionStatus())),delete t.status},this.handler=function(t,i,n){var o;if(t&&(this.dump(t,"Communicate Handler receive: "),i&&i.tab&&(t.tabId=i.tab.id,a||(a=i.tab.id),t.main_op)))switch(o=t.main_op,delete t.main_op,s.logBrowserAnalytics(t),l[t.tabId]&&l[t.tabId].suppress_frictionless&&(t.suppress_frictionless=l[t.tabId].suppress_frictionless),t.version=this.version,t.NMHConnStatus=e.getNMHConnectionStatus(),o){case"complete_conversion":e.createTab(t.conversion_url);break;case"analytics":break;case"third-party-cookies":this.handleThirdPartyCookiesResponse(t,i);break;case"relay_to_content":this.relayMessageToContentScript(t);break;case"viewer-startup":t.main_op="viewer-startup",this.sendViewerStartupInformation(t,i.tab.url);break;case"dismiss":this.closeDialog();break;default:return r[o]?(s.setOp({preview:"Copy",image_preview:"Image",send:"Send",fillsign:"FillSign",export:"Export",acom:"GotoAcom",to_pdf:"ConvertToPdf"}[t.handleResult]),r[o](t,i,n)):void e.consoleLog("failed to find handler for: "+o)}},this.closeDialog=function(){e.isFF()&&this.globals.panel.hide()},this.echoRequest=function(t){var i,n,o;if(!(SETTINGS.CHROME_VERSION<SETTINGS.SUPPORTED_VERSION)){if(!this.avoidUrl(t.url)){if(e.isFF())i=this.lastRequest||{panel_op:"html_menu"};else{var r=t.id||t.tabId;l[r]&&("cancelled"!==(i=l[r]).current_status&&"pdf_opened"!==i.current_status&&"pdf_failure"!==i.current_status&&"viewer_menu"!==i.panel_op||(o=i.is_pdf,this.clearStatus(i),i.is_pdf=o),i.current_status&&(i.panel_op="status"),this,n=i.is_pdf?"pdf_menu":"html_menu",i.panel_op&&"load-frictionless"===i.panel_op&&(delete i.panel_op,s.event(s.e.FRICTIONLESS_WIDGET_CLOSED)),"resize_window"===i.content_op&&(delete i.content_op,delete i.window_height),i.panel_op=i.panel_op||n,"html_menu"===n&&(i.persist=!1),i.incognito=t.incognito,t.url.startsWith("chrome-extension://"+chrome.runtime.id)?(i.panel_op="viewer_menu",i.is_viewer=!0):i.is_viewer=!1,e.consoleLog("repeat cached request: "+i.panel_op))}return i}this.disable(t.id)}},this.echo=function(t){if(s.event(s.e.TREFOIL_CLICKED),SETTINGS.CHROME_VERSION<SETTINGS.SUPPORTED_VERSION){this.getModule("session").newSession("data/js/options.html",!0,{})}else{var i=this.echoRequest(t);if(i){"search"===i.frictionless_workflow&&(i.suppress_frictionless=!0),i.trefoilClick=!0,i.frictionless_workflow=null,i.frame_visibility=null,i.persist=this.isEnablePersistMenu();let t=chrome.i18n.getMessage("@@ui_locale");i.locale=e.getFrictionlessLocale(t),this.sendMessage(i)}}},this.setGlobals=function(e){this.globals=e},this.dump=function(t,s){var i,n=[s];for(i in t)t.hasOwnProperty(i)&&n.push("  "+i+": "+t[i]);e.consoleLog(n.join("\n"))},this.sendMessage=function(t,i=!0){var n,o=t.tabId;this.dump(t,"Sending message:"),t.version=this.version,i&&(l[o]=e.extend(l[o],t)),e.showFrictionlessMenu(t)&&(t.show_frictionless=!0),t.NMHConnStatus=e.getNMHConnectionStatus();let r=this.getCookieStatus();r&&(t.cookieStatus=r),t.is_edge=e.isEdge(),"pdf_menu"===t.panel_op&&(t.trefoilClick?n=s.e.TREFOIL_PDF_FROM_CLICK:0==t.persist&&0!=t.version&&(n=s.e.TREFOIL_PDF_MENU_SHOWN)),"flickr"===t.panel_op&&(n=s.e.FLICKR_OFFER_SHOWN),"html_menu"===t.panel_op&&(n=s.e.TREFOIL_HTML_FROM_CLICK),n&&s.checkAndLogAnalytics(n),e.sendMessage(t,this.globals),delete t.trefoilClick},this.deferMessage=function(e){"undefined"==typeof setTimeout?this.sendMessage(e):setTimeout(this.proxy(this.sendMessage,e),0)},this.filenameFromUrl=function(e){try{const t=decodeURIComponent(e),s=t.split("?")[0].split("/").filter(e=>e.length>0),i=s.length>0?s[s.length-1]:"untitled";let n=i;const o=i.length-4;return(i.length<4||i.toLowerCase().indexOf(".pdf")!==o)&&(n+=".pdf"),n}catch(e){return"untitled.pdf"}},this.pdf_menu=function(t,i){var n;(n=l[i.tab.id]=e.extend(l[i.tab.id],{tabId:i.tab.id})).filename=this.filenameFromUrl(t.url),n.panel_op="pdf_menu",n.url=t.url,n.is_pdf=!0,n.incognito=i.tab.incognito,n.fteFeatureFlag=t.fteFeatureFlag,n.isFillnSignEnabled=SETTINGS.FILL_N_SIGN_ENABLED,n.isSharePointEnabled=o.isFeatureEnabled(),1==n.isSharePointEnabled&&(n.isSharePointURL=o.isAllowListedSharePointURL(n.url)),1==t.persist&&this.isEnablePersistMenu()?n.persist=!0:n.persist=!1;const r=e.getCookie("fteDenied");var a=!(0==t.version||1==t.version||t.version===SETTINGS.READER_VER||t.version===SETTINGS.ERP_READER_VER);const d=SETTINGS.VIEWER_ENABLED&&!e.getCookie("pdfViewer")&&(!r||10!==parseInt(r))&&(!a||SETTINGS.VIEWER_ENABLED_FOR_ACROBAT);if("false"!==e.getCookie("always-show-pdf-menu")&&(1!=n.persist||d||(delete n.fteFeatureFlag,s.event(s.e.PERSIST_PDF_MENU_SHOWN)),this.deferMessage(n)),d){let e;switch(t.fteFeatureFlag){case"dc-cv-fte-pdf-redcard":e=s.e.PERSIST_PDF_MENU_RED_CARD_FTE_SHOWN;break;case"dc-cv-fte-pdf-dmb":e=s.e.PERSIST_PDF_MENU_DMB_FTE_SHOWN;break;default:e=s.e.PERSIST_PDF_MENU_FTE_SHOWN}s.event(e)}"true"===localStorage.getItem("pdfViewer")&&s.event(s.e.VIEWER_ENABLED_PDF_OPEN_NATIVE_VIEWER)},this.loaded=function(t){l[t]=e.extend(l[t],{tabId:t,loaded:!0}),this.enable(t)},this.clearStatus=function(e,t){"in_progress"!==e.current_status&&"downloading"!==e.current_status&&(t||"waiting"!==e.current_status)&&(this.getModule("acro-web2pdf").cancelConversion(e.tabId),delete e.current_status,delete e.file_path,delete e.domtitle,delete e.timing,delete e.panel_op,delete e.is_pdf,delete e.trefoilUI,delete e.newUI)},this.loading=function(t){var s=t.id;l[s]=e.extend(l[s],{tabId:s,loaded:!1}),this.clearStatus(l[s],!0),this.enable(s)},this.active=function(t){if(a=t.tabId,l[a]=e.extend(l[a],{tabId:t.tabId}),this.isEnablePersistMenu()){var s=this.echoRequest(l[a]);s&&s.persist&&this.sendMessage(s)}},this.enable=function(e){var t=l[e].loaded?"data/images/acrobat_dc_appicon_24.png":"data/images/acrobat_dc_appicon_24_translucent.png";chrome.browserAction.setIcon({path:t,tabId:e}),l[e].loaded?chrome.browserAction.enable(e):chrome.browserAction.disable(e)},this.disable=function(e){l[e]&&(l[e].loaded=!1,this.enable(e))},this.close=function(e){this.getModule("acro-web2pdf").cancelConversion(e),delete l[e],a===e&&(a=null)},this.tabReplace=function(e,t){this.close(t),this.loaded(e)},this.activeTab=function(){return a},this.noop=function(){},this.avoidUrl=function(t){if(t=t||"",SETTINGS.VIEWER_ENABLED&&e.getCookie("pdfViewer")&&t.startsWith(`chrome-extension://${chrome.runtime.id}/viewer.html`))return!1;if(this.version===SETTINGS.ERP_READER_VER)return!0;if(t.startsWith("https://chrome.google.com"))return!0;if(this.version==SETTINGS.READER_VER&&0==SETTINGS.FRICTIONLESS_ENABLED)return!t.endsWith(".pdf")&&!t.endsWith(".PDF");if((0==this.version||1==this.version&&0==e.getNMHConnectionStatus())&&!1===SETTINGS.FRICTIONLESS_ENABLED)return!1;if(SETTINGS.FRICTIONLESS_ENABLED&&!t.endsWith(".pdf")&&!t.endsWith(".PDF")){const t=chrome.i18n.getMessage("@@ui_locale");if(null==e.getFrictionlessLocale(t)){if(this.version==SETTINGS.READER_VER)return!0;(0==this.version||1==this.version&&0==e.getNMHConnectionStatus())&&(SETTINGS.FRICTIONLESS_ENABLED=!1)}}return!t.startsWith("http")}},e.isChrome()&&(chrome.runtime.onMessage.addListener(l.proxy(l.handler)),chrome.tabs.onActivated.addListener(l.proxy(l.active)),chrome.tabs.onRemoved.addListener(l.proxy(l.close)),chrome.tabs.onCreated.addListener(l.proxy(l.loading)),chrome.tabs.onReplaced.addListener(l.proxy(l.tabReplace)))),l)l.hasOwnProperty(r)&&("function"==typeof l[r]?exports[r]=l[r].bind(l):exports[r]=l[r]);return l.registerHandlers({"send-analytics":l.proxy(l.noop)}),l}));